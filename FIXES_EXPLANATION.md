# Объяснение исправлений ошибок SSR

## Проблема

При попытке запустить приложение с SSR (Server-Side Rendering) возникали различные ошибки:

1. `ReferenceError: Cannot access 'API_URL' before initialization`
2. Проблемы с middleware в Redux store
3. Ошибки загрузки модулей на Windows
4. Отсутствие стилей

## Что было исправлено

### 1. Разделение констант на отдельные файлы

**Проблема:** `API_URL` и `SERVER_HOST` были в одном файле `constants.tsx`, который вызывал циклические зависимости.

**Решение:**

- Вынесли `API_URL` в отдельный файл `src/config/api.ts`
- Вынесли `SERVER_HOST` в отдельный файл `src/config/server.ts`
- В `constants.tsx` теперь просто реэкспортируем эти значения

**Почему это работает:** Каждый файл теперь независим, нет циклов в зависимостях.

### 2. Исправление путей к файлам на Windows

**Проблема:** На Windows модули нужно загружать через специальные URL-адреса вида `file:///`, а не просто пути.

**Решение:** Использовали функцию `pathToFileURL()` для преобразования обычного пути в правильный URL для Windows.

**Пример:**

```typescript
// Было (не работало):
render = (await import(pathToServer)).render

// Стало (работает):
const serverModuleUrl = pathToFileURL(pathToServer).href
render = (await import(serverModuleUrl)).render
```

### 3. Создание отдельного store для сервера

**Проблема:** Redux store с RTK Query middleware не работал на сервере, вызывая ошибку "each middleware must be a function".

**Решение:**

- Создали общую функцию `createStore()` в `store.ts`, которая проверяет, где запускается код (сервер или клиент)
- На сервере не добавляем RTK Query middleware (они не нужны для SSR)
- На клиенте добавляем все middleware как обычно

**Почему это работает:**

- На сервере нам не нужны запросы к API через RTK Query
- На клиенте все работает как раньше
- Один код работает и на сервере, и на клиенте

### 4. Исправление путей к файлам в production

**Проблема:** В production режиме пути складывались неправильно, получалось `dist/dist/client/index.html` вместо `dist/client/index.html`.

**Решение:**

- Поняли, что `clientPath` уже указывает на папку `dist`
- Убрали лишний `dist` из всех путей
- Теперь используем `clientPath + 'client/index.html'` вместо `clientPath + 'dist/client/index.html'`

### 5. Подключение стилей

**Проблема:** После удаления ServerStyleSheet стили не подключались.

**Решение:**

- В development: Vite сам добавляет стили через `transformIndexHtml()`
- В production: читаем уже готовый `index.html` из `dist/client/`, где Vite уже добавил ссылки на CSS файлы

**Почему это работает:** Vite автоматически обрабатывает CSS при сборке, нам просто нужно использовать то, что он создал.

## Итог

Все исправления направлены на то, чтобы:

1. Избежать циклических зависимостей между файлами
2. Правильно работать с модулями на Windows
3. Использовать упрощенный store на сервере (без ненужных middleware)
4. Правильно находить файлы в разных режимах (dev/production)
5. Использовать стили, которые Vite уже подготовил при сборке

Теперь приложение работает как на сервере (для SSR), так и на клиенте (для обычной работы).
